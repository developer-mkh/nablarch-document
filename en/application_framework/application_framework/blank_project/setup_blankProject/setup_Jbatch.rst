=========================================================
Initial Setup of JSR352-compliant Batch Project
=========================================================

The following is configured in the initial setup of JSR352-compliant batch project:

* Generate a JSR352-compliant batch project
* Operation check of the JSR352-compliant batch project


Overview of the generated project
=========================================================

The overview of the project generated by this procedure is as follows.

.. list-table::
  :header-rows: 1
  :class: white-space-normal
  :widths: 7,20

  * - Item
    - Description
  * - Project type
    - Maven project
  * - Project configuration
    - Single project configuration
  * - DB used
    - H2 Database Engine (embedded in the application)
  * - What is included in the generated project?
    - The following is included in the generated project:

      * Basic configuration for the JSR352-compliant batch application
      * Batch application for communication confirmation by the batchlet architecture
      * Batch application for communication confirmation by the chunk architecture
      * Application for communication confirmation using the ETL function \ [#footnote-etl]_\
      * Initial configuration of the tool that operates in conjunction with Maven (is imported by referring to :ref:`about_maven_parent_module`).


.. [#footnote-etl] Since the class to execute ETL exists in Nablarch, the project contains only the configuration file, DTO class and entity class used by ETL.


For relationship with other projects and directories, see :doc:`../MavenModuleStructures/index`.


.. _firstStepGenerateBatchEEBlankProject:

Create blank project
=======================================================

Generate a blank project using the archetypes provided by Nablarch.


Execute the mvn command
-------------------------------------------------------

Change the current directory to the directory where the blank project (can be any directory) is to be created and place the following file.

:download:`Batch file <bat/generateJbatchProject.bat>`

After placing the file, specify the necessary parameters in the arguments and execute the bat file.

generateJbatchProject.bat |nablarch_version| <<groupId>> <<artifactId>> <<version>> <<package(任意)>>

The parameters configured in the above command are as follows.
If you want to change the version of Nablarch, change |nablarch_version|.

=========== ================================================= =======================
Input item  Description                                       Configuration example
=========== ================================================= =======================
groupId      Group ID (normally, enter the package name)      ``com.example``
artifactId   Artifact ID                                      ``myapp-batch-ee``
version      Version number                                   ``0.1.0``
package      Package (normally the same as group ID)          ``com.example``
=========== ================================================= =======================

.. important::
   Item groupId and package are mapped to the Java package name.
   Use lowercase letters, numbers, and dots for these input values, and do not use hyphens.

If the command ends normally, a blank project is created under the current directory.


.. _firstStepBatchEEStartupTest:

Communication confirmation
=====================================================

Automated test
-----------------------------------------------------

The following unit tests are included in the project generated from the archetype.

.. list-table::
  :header-rows: 1
  :class: white-space-normal
  :widths: 9,20

  * - Unit test classes
    - Test content
  * - SampleBatchletTest
    - JUnit test for classes with database connection.


Execute the unit test and confirm that the blank project was successfully generated.

Execute the following command.

.. code-block:: text

  cd myapp-batch-ee
  mvn test


If the execution is successful, the log given below will be output to the console.

.. code-block:: text

  (Omitted)
  [INFO] ------------------------------------------------------------------------
  [INFO] Building myapp-batch-ee 0.1.0
  [INFO] ------------------------------------------------------------------------
  (Omitted)
  2016-08-26 09:41:52.727 -INFO- ROO [null] 削除件数：10件
  2016-08-26 09:41:52.728 -DEBUG- SQL [null] nablarch.core.db.statement.BasicSqlPStatement#executeQuery
          SQL = [SELECT FAMILY_NAME,FIRST_NAME,USER_ID FROM SAMPLE_USER]
          additional_info:

  2016-08-26 09:41:52.728 -DEBUG- SQL [null] nablarch.core.db.statement.BasicSqlPStatement#executeQuery
          execute_time(ms) = [0]
  Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 1.385 sec - in com.example.batchlet.SampleBatchletTest

  Results :

  Tests run: 1, Failures: 0, Errors: 0, Skipped: 0

  [INFO] ------------------------------------------------------------------------
  [INFO] BUILD SUCCESS
  [INFO] ------------------------------------------------------------------------
  (rest is omitted)



Launch test
--------------------------------------------------------

The following batch applications are incorporated in the project that is generated.

=================== ================================================================================
Job ID              Details
=================== ================================================================================
sample-batchlet     Sample application implemented by the batchlet architecture.
sample-chunk        Sample application implemented by the chunk architecture.
sample-etl          Sample application of the ETL function provided by Nablarch.
=================== ================================================================================


Check the operations of the above 3 batch applications and confirm that the blank project has been successfully generated.


.. _firstStepBatchEEBuild:

Build a batch application
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If the current directory is not yet moved to the generated project, move the directory.

.. code-block:: text

  cd myapp-batch-ee


Execute the following command to build the batch application.

.. code-block:: text

  mvn package

Launch the batch application of the batchlet architecture
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The batch application of the batchlet architecture implements the process to delete the data of the SAMPLE_USER table.

Execute the following command.

.. code-block:: bash

  mvn exec:java -Dexec.mainClass=nablarch.fw.batch.ee.Main -Dexec.args="'sample-batchlet'"

If the execution is successful, the log given below will be output to ``log/progress.log``.

.. code-block:: text

  11:27:28.099 INFO  progress start job. job name: [sample-batchlet]
  11:27:28.105 INFO  progress start step. job name: [sample-batchlet] step name: [step1]
  11:27:28.986 INFO  progress finish step. job name: [sample-batchlet] step name: [step1] step status: [SUCCESS]
  11:27:28.986 INFO  progress finish job. job name: [sample-batchlet]

.. tip::

  This batchlet deletes all the data in the SAMPLE_USER table. To recover deleted data, execute the :ref:`firstStepBatchEERunETL` command.



.. _firstStepBatchEERunETL:

Launch an application that uses the ETL function
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The application that uses the ETL function is configured to input data to the SAMPLE_USER table.


Execute the following command.

.. code-block:: bash

  mvn exec:java -Dexec.mainClass=nablarch.fw.batch.ee.Main -Dexec.args="'sample-etl'"

If the launch is successful, the log given below will be output to ``log/progress.log``.

.. code-block:: text

  11:28:45.260 INFO  progress start step. job name: [sample-etl] step name: [load]
  11:28:45.270 INFO  progress job name: [sample-etl] step name: [load] input count: [10]
  11:28:45.274 INFO  progress job name: [sample-etl] step name: [load] write table name: [SAMPLE_USER]
  11:28:45.278 INFO  progress job name: [sample-etl] step name: [load] tps: [1250.00] estimated end time: [2017/04/27 11:28:45.278] remaining count: [0]
  11:28:45.278 INFO  progress finish step. job name: [sample-etl] step name: [load] step status: [COMPLETED]
  11:28:45.278 INFO  progress finish job. job name: [sample-etl]


Launch the batch application of the chunk architecture
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The batch application of the chunk architecture implements the process to extract data from the SAMPLE_USER table, edit the data, and output data to a CSV file.

Execute the following command.

.. code-block:: bash

  mvn exec:java -Dexec.mainClass=nablarch.fw.batch.ee.Main -Dexec.args="'sample-chunk'"

If the launch is successful, the log given below will be output to ``log/progress.log``.

.. code-block:: text

  11:30:10.664 INFO  progress start job. job name: [sample-chunk]
  11:30:10.669 INFO  progress start step. job name: [sample-chunk] step name: [step1]
  11:30:11.372 INFO  progress job name: [sample-chunk] step name: [step1] input count: [10]
  11:30:11.394 INFO  progress job name: [sample-chunk] step name: [step1] tps: [238.10] estimated end time: [2017/04/27 11:30:11.394] remaining count: [5]
  11:30:11.395 INFO  progress job name: [sample-chunk] step name: [step1] tps: [434.78] estimated end time: [2017/04/27 11:30:11.395] remaining count: [0]
  11:30:11.397 INFO  progress finish step. job name: [sample-chunk] step name: [step1] step status: [COMPLETED]
  11:30:11.398 INFO  progress finish job. job name: [sample-chunk]


The following data is output to testdata/output/outputdata.csv.

.. code-block:: text

  ユーザID,氏名
  1,名部楽 一郎
  2,名部楽 二郎
  3,名部楽 三郎
  4,名部楽 四朗
  5,名部楽 五郎
  6,名部楽 六郎
  7,名部楽 七郎
  8,名部楽 八郎
  9,名部楽 九郎
  10,名部楽 十郎


.. tip::

  testdata/output/outputdata.csv is output in UTF-8.
  When checking the contents of testdata testdata/output/outputdata.csv, open the file with a text editor as the contents will be garbled if opened with excel.


If the communication confirmation fails for some reason
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If the communication confirmation fails for some unknown reason, the correct procedure may not have been followed in some part.

If the reason is not known, try again from :ref:`firstStepGenerateBatchEEBlankProject`.



Supplementary notes
--------------------

For information on the method of confirming the data of H2 and tools included in the blank project,
see :doc:`../firstStep_appendix/firststep_complement`.